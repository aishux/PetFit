import numpy as np

from pytidb import TiDBClient
from pytidb.schema import TableModel, Field, DistanceMetric
from pytidb.embeddings import EmbeddingFunction
from typing import List, Optional
import os
from dotenv import load_dotenv
import time
from PIL import Image


load_dotenv()


# ── CONFIG ────────────────────────────────────────────────────────────────
TIDB_HOST = os.getenv("TIDB_HOST")
TIDB_USER = os.getenv("TIDB_USER")
TIDB_PASS = os.getenv("TIDB_PASS")
TIDB_PORT = os.getenv("TIDB_PORT")
TIDB_DATABASE = os.getenv("TIDB_DATABASE")
JINA_AI_API_KEY = os.getenv("JINA_AI_API_KEY")
# ── END CONFIG ────────────────────────────────────────────────────────────


TIDB_DATABASE_URL=f"mysql+pymysql://{TIDB_USER}:{TIDB_PASS}@{TIDB_HOST}:{TIDB_PORT}/{TIDB_DATABASE}?ssl_ca=/etc/ssl/cert.pem"

db = TiDBClient.connect(TIDB_DATABASE_URL)


image_embed = EmbeddingFunction(
    model_name="jina_ai/jina-embeddings-v4",
    api_key=JINA_AI_API_KEY,
    multimodal=True,
    timeout=90
)

angry_image_urls = ['https://storage.googleapis.com/pet_image_storage/Angry/04_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/10_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/31_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/82_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/25_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/73_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/09_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/67_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/46_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/52_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/28_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/84_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/37_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/23_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/59_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/02_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/78_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/16_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/89_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/54_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/61_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/05_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/24_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/30_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/83_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/72_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/08_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/53_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/29_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/47_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/22_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/58_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/91_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/85_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/36_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/17_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/03_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/79_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/55_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/41_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/60_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/74_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/49_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/80_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/94_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/27_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/06_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/12_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/68_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/50_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/71_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/86_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/35_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/21_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/92_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/77_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/63_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/19_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/42_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/38_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/56_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/26_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/32_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/48_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/81_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/69_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/51_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/45_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/70_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/20_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/93_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/87_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/18_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/76_angry.jpg', 'https://storage.googleapis.com/pet_image_storage/Angry/57_angry.jpg']

sad_image_urls = ['https://storage.googleapis.com/pet_image_storage/Sad/105_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/099_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/089_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/052_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/064_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/006_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/016_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/080_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/039_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/075_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/065_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/017_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/007_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/028_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/038_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/091_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/081_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/104_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/031_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/021_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/088_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/098_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/053_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/005_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/067_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/077_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/083_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/093_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/058_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/041_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/051_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/023_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/050_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/040_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/032_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/004_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/076_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/066_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/092_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/082_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/059_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/087_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/001_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/011_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/063_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/073_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/045_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/055_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/037_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/102_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/008_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/054_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/044_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/036_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/026_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/103_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/009_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/019_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/096_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/086_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/010_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/072_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/062_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/024_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/046_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/056_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/101_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/079_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/084_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/094_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/070_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/002_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/012_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/095_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/085_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/071_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/061_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/013_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/003_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/035_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/025_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/057_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/047_sad.jpg', 'https://storage.googleapis.com/pet_image_storage/Sad/078_sad.jpg']

happy_image_urls = ['https://storage.googleapis.com/pet_image_storage/happy/103_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/051_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/098_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/070_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/064_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/032_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/081_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/095_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/026_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/007_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/013_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/069_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/076_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/062_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/018_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/043_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/039_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/057_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/111_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/001_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/015_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/108_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/034_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/020_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/093_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/050_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/099_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/102_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/044_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/071_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/094_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/027_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/080_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/049_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/012_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/068_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/006_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/063_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/019_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/077_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/110_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/056_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/021_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/092_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/035_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/072_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/008_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/066_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/047_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/101_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/053_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/029_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/030_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/083_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/097_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/024_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/107_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/041_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/088_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/055_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/074_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/060_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/085_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/036_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/022_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/058_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/003_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/079_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/017_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/067_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/073_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/009_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/052_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/028_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/004_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/096_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/025_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/031_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/112_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/054_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/040_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/106_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/061_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/075_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/023_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/090_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/084_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/037_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/002_happy.jpg', 'https://storage.googleapis.com/pet_image_storage/happy/078_happy.jpg']


class PetExpressionsIdentification(TableModel, table=True):
    __tablename__ = "pet_expression_identification"

    id: int = Field(primary_key=True)
    expression_identification: str = Field()
    image_uri: str = Field()
    image_vec: Optional[List[float]] = image_embed.VectorField(
            distance_metric=DistanceMetric.L2,
            source_field="image_uri",
            source_type="image",
        )

# table = db.create_table(schema=PetExpressionsIdentification, if_exists='skip')

# print("Connected to TiDB database and created table!")

# items_lst = []
# count = 0
# for exp in {"angry":angry_image_urls, "sad": sad_image_urls, "happy": happy_image_urls}.items():
#     for img_url in exp[1]:
#         items_lst.append(PetExpressionsIdentification(
#             id = 11231412 + count,
#             expression_identification=exp[0],
#             image_uri = img_url
#         ))
#         count += 1

#     table.bulk_insert(items_lst)
#     print(f"Inserted data for expression: {exp[0]}")
#     items_lst = []

#     time.sleep(60)


# print("Inserted all the data into the table!")

table = db.open_table("pet_expression_identification")

# image = Image.open("../Datasets/PetExpressions/Data/test/Angry/11.jpg")
image = Image.open("../Datasets/PetExpressions/Data/test/022.jpg")
# results = table.search("https://iili.io/K2nt9hx.jpg").limit(1).to_list()
# results = table.search("https://storage.googleapis.com/pet_image_storage/test1.jpg").limit(1).to_list()
# results = table.search("https://storage.googleapis.com/pet_image_storage/test2.jpg").limit(1).to_list()
results = table.search(image).limit(1).to_list()

print(results)